---
- name: Using General, Buildin collection  
  hosts: fbsd-zabbix-server
  remote_user: root
  collections:
    - community.general
    - community.postgresql
    - ansible.builtin
    - ansible.posix

  vars_files:
    - vars/vars.yml

  tasks:
  - name: Install package postgresql12-server
    pkgng:
      name: postgresql12-server
      state: present

  - name: Install package apache24
    pkgng:
      name: apache24
      state: present

  - name: Install package php
    pkgng:
      name: mod_php74, php74, php74-bcmath, php74-ctype, php74-dom, php74-fileinfo, php74-filter, php74-gd, php74-gettext, php74-json, php74-ldap, php74-mbstring, php74-openssl, php74-session, php74-simplexml, php74-snmp, php74-sockets, php74-xml, php74-xmlreader, php74-xmlwriter, php74-pgsql
      state: present      

  - name: Install package for easy compilation agent, server, frontend and timescaledb
    pkgng:
      name: pkgconf, fping, autoconf, gmake, cmake, re2c, texinfo, m4, help2man, unixODBC, net-snmp, libevent, curl, perl5, portupgrade, libunwind, libedit, php74, openipmi, libtextstyle, gettext-tools, mpdecimal, ninja
      state: present

  - name: Install package zabbix54-agent
    portinstall:
      name: net-mgmt/zabbix54-agent
      state: present

  - name: Create a directory net-mgmt_zabbix54-server if it does not exist
    file:
      path: /var/db/ports/net-mgmt_zabbix54-server/
      state: directory
      owner: root
      group: wheel
      mode: 0755

  - name: Copy zabbix54-server build options
    copy:
      src: ./files/net-mgmt_zabbix54-server_options
      dest: /var/db/ports/net-mgmt_zabbix54-server/options
      owner: root
      group: wheel
  
  - name: Install package zabbix54-server
    portinstall:
      name: net-mgmt/zabbix54-server
      state: present

  - name: Create a directory net-mgmt_zabbix54-frontend if it does not exist
    file:
      path: /var/db/ports/net-mgmt_zabbix54-frontend/
      state: directory
      owner: root
      group: wheel
      mode: 0755

  - name: Copy zabbix54-frontend build options
    copy:
      src: ./files/net-mgmt_zabbix54-frontend_options
      dest: /var/db/ports/net-mgmt_zabbix54-frontend/options
      owner: root
      group: wheel

  - name: Install package zabbix54-frontend
    portinstall:
      name: net-mgmt/zabbix54-frontend
      state: present

  - name: Install package py-psycopg2
    portinstall:
      name: databases/py-psycopg2
      state: present

  - name: Enable service zabbix_agentd, and not touch the state
    service:
      name: zabbix_agentd
      enabled: yes

  - name: Enable service zabbix_server, and not touch the state
    service:
      name: zabbix_server
      enabled: yes

  - name: Enable service apache24, and not touch the state
    service:
      name: apache24
      enabled: yes

  - name: Enable service postgresql, and not touch the state
    service:
      name: postgresql
      enabled: yes

  - name: Copy sample zabbix_agentd.conf
    copy:
      src: ./conf/zabbix54_agentd.conf.sample
      dest: /usr/local/etc/zabbix54/zabbix_agentd.conf
      owner: root
      group: wheel

  - name: Copy sample zabbix_server.conf
    copy:
      src: ./conf/zabbix54_server.conf.sample
      dest: /usr/local/etc/zabbix54/zabbix_server.conf
      owner: root
      group: wheel

  - name: Edit zabbix_agentd.conf Hostname=
    lineinfile:
      path: /usr/local/etc/zabbix54/zabbix_agentd.conf
      regexp: ^Hostname=.*
      line: Hostname={{ ansible_fqdn }}

  - name: Edit zabbix_agentd.conf Server=
    lineinfile:
      path: /usr/local/etc/zabbix54/zabbix_agentd.conf
      regexp: ^Server=.*
      line: Server={{ zabbix_server }}

  - name: Start service zabbix54-agent, if not started
    service:
      name: zabbix_agentd
      state: started

  - name: Initdb service postgresql
    shell: /usr/local/etc/rc.d/postgresql initdb

  - name: Start service postgresql, if not started
    service:
      name: postgresql
      state: started

  - name: Create root user postgresql
    shell: su -m postgres -c "createuser -s root"

  - name: Create user zabbix
    postgresql_user:
      name: zabbix
      state: present

  - name: Create a directory /data/pgsql for tablespace
    file:
      path: /data/pgsql/
      state: directory
      owner: postgres
      group: postgres
      mode: 0755

  - name: Create a new tablespace called zabbix and set zabbix as an its owner
    postgresql_tablespace:
      name: zabbix
      owner: zabbix
      location: /data/pgsql

  - name: Create a new database with name 'zabbix'
    postgresql_db:
      name: zabbix
      tablespace: zabbix
      encoding: UTF-8
      state: present

  - name: Import Zabbix schema.sql from SQL script
    postgresql_query:
      db: zabbix
      path_to_script: /usr/local/share/zabbix54/server/database/postgresql/schema.sql

  - name: Import Zabbix images.sql from SQL script
    postgresql_query:
      db: zabbix
      path_to_script: /usr/local/share/zabbix54/server/database/postgresql/images.sql

  - name: Import Zabbix data.sql from SQL script
    postgresql_query:
      db: zabbix
      path_to_script: /usr/local/share/zabbix54/server/database/postgresql/data.sql

  - name: Import Zabbix double.sql from SQL script
    postgresql_query:
      db: zabbix
      path_to_script: /usr/local/share/zabbix54/server/database/postgresql/double.sql

  - name: Install package timescaledb
    portinstall:
      name: databases/timescaledb
      state: present

  - name: Config file templates/postgresql.conf
    template:
      src: "./templates/templates/postgresql.conf.j2"
      dest: "/var/db/postgres/data12/postgresql.conf"
      owner: postgres
      group: postgres
      mode: 0400

  - name: Restart service postgresql
    service:
      name: postgresql
      state: restarted

  - name: Create extension TimescaleDB
    postgresql_query:
      db: zabbix
      query: CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE

  - name: Import Zabbix timescaledb.sql from SQL script
    postgresql_query:
      db: zabbix
      path_to_script: /usr/local/share/zabbix54/server/database/postgresql/timescaledb.sql

#  - name: Edit zabbix_server.conf DBPassword=
#    lineinfile:
#      path: /usr/local/etc/zabbix54/zabbix_server.conf
#      regexp: ^# DBPassword=.*
#      line: DBPassword={{ mysql_zabbix_password }}

#  - name: Start service zabbix54-server, if not started
#    service:
#      name: zabbix_server
#      state: started

  - name: Copy zabbix.conf
    copy:
      src: ./conf/zabbix54.conf
      dest: /usr/local/etc/apache24/Includes/zabbix.conf
      owner: root
      group: wheel

  - name: Apply patch to file httpd.conf
    patch:
      src: ./files/httpd.conf.patch
      dest: /usr/local/etc/apache24/httpd.conf

  - name: Config file zabbix.conf.php
    template:
      src: "./templates/zabbix54.conf.php.j2"
      dest: "/usr/local/www/zabbix54/conf/zabbix.conf.php"
      owner: www
      group: www
      mode: 0400

  - name: Start service apache24, if not started
    service:
      name: apache24
      state: started
      
# EOF